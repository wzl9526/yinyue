
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Gravity Synth ğŸ¹</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505; /* æ·±é»‘èƒŒæ™¯ */
            font-family: 'Courier New', monospace;
            user-select: none;
        }
        canvas { display: block; }
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            color: #00ffcc;
            z-index: 10;
            transition: opacity 0.5s;
        }
        h1 { font-size: 40px; text-shadow: 0 0 10px #00ffcc; margin-bottom: 20px; }
        p { color: #fff; font-size: 18px; margin-bottom: 30px; }
        button {
            padding: 15px 40px;
            font-size: 20px;
            background: transparent;
            color: #00ffcc;
            border: 2px solid #00ffcc;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 0 15px #00ffcc;
            transition: all 0.3s;
        }
        button:hover { background: #00ffcc; color: #000; }
        #controls {
            position: absolute;
            top: 20px; left: 20px;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>Gravity Music Lab</h1>
        <p>åˆ’åŠ¨é¼ æ ‡ç”»çº¿ Â· çƒä½“æ’å‡»å‘å£° Â· æ„å»ºä½ çš„æ—‹å¾‹</p>
        <button id="startBtn">å¼€å§‹æ¼”å¥ / Start</button>
    </div>

    <div id="controls">
        [å·¦é”®æ‹–åŠ¨] ç”»çº¿ (Draw Line)<br>
        [å³é”®ç‚¹å‡»] æ¸…ç©ºç”»å¸ƒ (Clear)<br>
        [Space] æš‚åœ/ç”Ÿæˆ (Pause/Spawn)
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // --- éŸ³é¢‘ç³»ç»Ÿ (Web Audio API) ---
        let audioCtx;
        // äº”å£°éŸ³é˜¶é¢‘ç‡ (Pentatonic Scale) - æ— è®ºæ€ä¹ˆä¹±å¼¹éƒ½å¥½å¬
        const scale = [
            130.81, 146.83, 164.81, 196.00, 220.00, // C3, D3, E3, G3, A3
            261.63, 293.66, 329.63, 392.00, 440.00, // C4...
            523.25, 587.33, 659.25, 783.99, 880.00  // C5...
        ];

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(velocity, yPos) {
            if (!audioCtx) return;

            // æ ¹æ®é«˜åº¦å†³å®šéŸ³é«˜ (ä½ç½®è¶Šé«˜ï¼ŒéŸ³è°ƒè¶Šé«˜)
            const pitchIndex = Math.floor((1 - yPos / height) * scale.length);
            const frequency = scale[Math.max(0, Math.min(scale.length - 1, pitchIndex))];

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            // é€‰ç”¨æ­£å¼¦æ³¢æˆ–ä¸‰è§’æ³¢ï¼Œå£°éŸ³æ¸©æ¶¦
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);

            // æ ¹æ®æ’å‡»é€Ÿåº¦å†³å®šéŸ³é‡
            const vol = Math.min(velocity * 0.1, 0.5);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5); // 0.5ç§’æ·¡å‡º

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        // --- ç‰©ç†ç³»ç»Ÿ ---
        const gravity = 0.2;
        const balls = [];
        const lines = [];
        let particles = []; // ç¢°æ’ç«èŠ±

        class Ball {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = 0;
                this.radius = 5;
                this.color = `hsl(${Math.random()*360}, 100%, 70%)`;
                this.dead = false;
            }
            update() {
                this.vy += gravity;
                this.x += this.vx;
                this.y += this.vy;

                // ç®€å•çš„ç©ºæ°”é˜»åŠ›
                this.vx *= 0.999;
                this.vy *= 0.999;

                // è¾¹ç•Œæ£€æµ‹
                if (this.x < 0 || this.x > width) this.vx *= -0.8;
                if (this.y > height + 50) this.dead = true;

                // çº¿æ¡ç¢°æ’æ£€æµ‹
                for (let line of lines) {
                    this.checkLineCollision(line);
                }
            }
            checkLineCollision(line) {
                // å‘é‡è®¡ç®—ï¼šç‚¹åˆ°çº¿æ®µçš„è·ç¦»
                const dx = line.x2 - line.x1;
                const dy = line.y2 - line.y1;
                const lenSq = dx*dx + dy*dy;
                let t = ((this.x - line.x1) * dx + (this.y - line.y1) * dy) / lenSq;
                t = Math.max(0, Math.min(1, t)); // é™åˆ¶åœ¨çº¿æ®µèŒƒå›´å†…

                const closestX = line.x1 + t * dx;
                const closestY = line.y1 + t * dy;

                const distX = this.x - closestX;
                const distY = this.y - closestY;
                const dist = Math.sqrt(distX*distX + distY*distY);

                if (dist < this.radius + line.width/2) {
                    // å‘ç”Ÿç¢°æ’
                    // è®¡ç®—æ³•çº¿
                    const nx = -dy; // ç®€åŒ–çš„æ³•çº¿è®¡ç®—
                    const ny = dx;
                    const nLen = Math.sqrt(nx*nx + ny*ny);
                    const normalX = nx / nLen;
                    const normalY = ny / nLen;

                    // åªæœ‰å½“çƒæœå‘çº¿æ¡æ’å‡»æ—¶æ‰åå¼¹ (ç‚¹ç§¯ < 0)
                    const dot = this.vx * normalX + this.vy * normalY;

                    // ä¿®æ­£åå¼¹é€»è¾‘ï¼Œå¤„ç†çº¿æ¡åŒé¢
                    // è¿™é‡Œç®€åŒ–ï¼šç›´æ¥åè½¬é€Ÿåº¦åˆ†é‡å¹¶æ·»åŠ å¼¹åŠ›
                    // æ›´ä¸¥è°¨çš„åšæ³•æ˜¯åå°„å‘é‡ V_new = V - 2(V.N)N

                    // ç®€å•åå°„ç®—æ³•
                    if (prevDist > dist) { // ç¡®ä¿æ˜¯è¿›è¿‘çŠ¶æ€
                        // æ’­æ”¾å£°éŸ³ (é€Ÿåº¦è¶Šå¤§å£°éŸ³è¶Šå¤§)
                        const impactSpeed = Math.sqrt(this.vx*this.vx + this.vy*this.vy);
                        if (impactSpeed > 1) {
                            playSound(impactSpeed, this.y);
                            createParticles(this.x, this.y, this.color);
                            line.pulse = 10; // çº¿æ¡å‘å…‰
                        }

                        // åå°„å…¬å¼
                        const dot2 = 2 * (this.vx * normalX + this.vy * normalY);
                        this.vx = (this.vx - dot2 * normalX) * 0.7; // 0.7æ˜¯å¼¹æ€§ç³»æ•°ï¼Œèƒ½é‡æŸè€—
                        this.vy = (this.vy - dot2 * normalY) * 0.7;

                        // é˜²æ­¢é™·å…¥çº¿æ¡å†…éƒ¨ï¼Œæ¨å‡ºæ¥ä¸€ç‚¹
                        this.x += normalX * (this.radius - dist + 1);
                        this.y += normalY * (this.radius - dist + 1);
                    }
                }
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        // è®°å½•ä¸Šä¸€å¸§çš„è·ç¦»ï¼Œç”¨äºé˜²ç©¿é€åˆ¤æ–­
        let prevDist = 100; 

        class Line {
            constructor(x1, y1, x2, y2) {
                this.x1 = x1; this.y1 = y1;
                this.x2 = x2; this.y2 = y2;
                this.width = 4;
                this.color = '#00ffcc';
                this.pulse = 0; // æ’å‡»æ—¶çš„å‘å…‰å¼ºåº¦
            }
            draw() {
                ctx.beginPath();
                ctx.moveTo(this.x1, this.y1);
                ctx.lineTo(this.x2, this.y2);
                ctx.lineWidth = this.width + this.pulse;

                // é¢œè‰²æ¸å˜å¤„ç†
                const r = Math.floor(this.pulse * 20);
                ctx.strokeStyle = `rgb(${r}, ${255}, ${204 + r})`;
                ctx.shadowBlur = this.pulse * 2 + 5;
                ctx.shadowColor = '#00ffcc';

                ctx.lineCap = 'round';
                ctx.stroke();
                ctx.shadowBlur = 0;

                if (this.pulse > 0) this.pulse *= 0.9; // å‘å…‰è¡°å‡
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 5;
                this.vy = (Math.random() - 0.5) * 5;
                this.life = 1.0;
                this.color = color;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.05;
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 2, 2);
                ctx.globalAlpha = 1;
            }
        }

        function createParticles(x, y, color) {
            for(let i=0; i<5; i++) particles.push(new Particle(x, y, color));
        }

        // --- äº¤äº’é€»è¾‘ ---
        let isDrawing = false;
        let startX, startY;
        let mouseX, mouseY;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);

        canvas.addEventListener('mousedown', e => {
            if (e.button === 0) { // å·¦é”®
                isDrawing = true;
                startX = e.clientX;
                startY = e.clientY;
            }
        });

        canvas.addEventListener('mousemove', e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        canvas.addEventListener('mouseup', e => {
            if (isDrawing && e.button === 0) {
                isDrawing = false;
                // æ·»åŠ æ–°çº¿æ¡
                const dist = Math.sqrt((e.clientX-startX)**2 + (e.clientY-startY)**2);
                if (dist > 10) { // å¤ªçŸ­çš„çº¿ä¸ç”»
                    lines.push(new Line(startX, startY, e.clientX, e.clientY));
                }
            }
        });

        // å³é”®æ¸…é™¤
        canvas.addEventListener('contextmenu', e => {
            e.preventDefault();
            lines.length = 0; // æ¸…ç©ºçº¿æ¡
        });

        // --- ä¸»å¾ªç¯ ---
        function loop() {
            ctx.fillStyle = 'rgba(5, 5, 5, 0.3)'; // æ‹–å°¾æ•ˆæœ
            ctx.fillRect(0, 0, width, height);

            // ç”Ÿæˆçƒä½“ (æ¯éš”å‡ å¸§)
            if (Math.random() > 0.95 && balls.length < 50) {
                balls.push(new Ball(width/2 + (Math.random()-0.5)*20, 0));
            }

            // æ›´æ–°ç»˜åˆ¶çƒ
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                b.update();
                b.draw();
                if (b.dead) balls.splice(i, 1);
            }

            // æ›´æ–°ç»˜åˆ¶çº¿
            lines.forEach(l => l.draw());

            // ç»˜åˆ¶æ­£åœ¨ç”»çš„çº¿
            if (isDrawing) {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(mouseX, mouseY);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // ç²’å­ç‰¹æ•ˆ
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.update();
                p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }

            requestAnimationFrame(loop);
        }

        // --- å¯åŠ¨ ---
        document.getElementById('startBtn').addEventListener('click', () => {
            initAudio();
            document.getElementById('overlay').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
            }, 500);
            resize();
            loop();
        });

    </script>
</body>
</html>
